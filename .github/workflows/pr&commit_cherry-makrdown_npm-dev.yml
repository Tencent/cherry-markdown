name: PR Merge cherry-markdown Dev NPM Preview

on:
  pull_request_target:
    types: [closed]
    paths: 
      - "packages/cherry-markdown/**"

permissions:
  contents: read
  pull-requests: write
  issues: write

jobs:
  cherrymarkdown-preview:
    # ä¸éœ€è¦åœ¨forkä»“åº“çš„prä¸­è¿è¡Œ, ä»…å½“pråˆå¹¶æ—¶è¿è¡Œ
    if: github.repository == 'Tencent/cherry-markdown' && github.event.pull_request.merged == true
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Get Merge Commit SHA
        run: echo "COMMIT_SHORT_SHA=${GITHUB_SHA:0:7}" >> $GITHUB_ENV

      - name: Install dependencies
        run: sudo apt-get install -y moreutils

      - name: Update package.json
        working-directory: ./packages/cherry-markdown
        run: |
          BASE_VERSION=$(jq -r .version package.json)
          VERSION="${BASE_VERSION}-dev.$(date +'%Y%m%d%H%M').${{ env.COMMIT_SHORT_SHA }}"
          jq --arg name "@cherry-markdown/cherry-markdown-dev" \
             --arg version "$VERSION" \
             '.name = $name | .version = $version | del(.scripts.publish?)' package.json | sponge package.json
          echo "PACKAGE_VERSION=$VERSION" >> $GITHUB_ENV
          echo "PACKAGE_NAME=@cherry-markdown/cherry-markdown-dev" >> $GITHUB_ENV

      - name: Update README
        working-directory: ./packages/cherry-markdown
        run: |
          cat <<-EOF > README.md
            **âš ï¸ å¼€å‘é¢„è§ˆè­¦å‘Š / Development Preview Warning**

            æ­¤ç‰ˆæœ¬ä¸º[ä¸´æ—¶æµ‹è¯•ç‰ˆ](${PACKAGE_NAME}@${PACKAGE_VERSION})ï¼Œç¦æ­¢åœ¨ç”Ÿäº§ç¯å¢ƒä½¿ç”¨ï¼  

            This is a [development preview version](${PACKAGE_NAME}@${PACKAGE_VERSION}), do NOT use in production!  

          EOF

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 18
          registry-url: https://registry.npmjs.org/
          cache: yarn

      - name: Install and build
        working-directory: ./packages/cherry-markdown
        run: yarn install && yarn build
      
      - name: npm publish
        working-directory: ./packages/cherry-markdown
        run: npm publish
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN_ORG_DEV }}

      - name: Post comments
        uses: actions/github-script@v7
        with:
          script: |
           // å·¥å…·å‡½æ•°ï¼šå¢å¼ºå‹ Issue æå– (TODO: æœªæ¥åªæ”¯æŒå½“å‰ prè¿›è¡Œè¯„è®º-ç¡®ä¿å®‰å…¨)
            const extractValidReferences = (text) => {
              if (!text) return [];
              // åŒ¹é…å½“å‰ä»“åº“æ ¼å¼çš„ #æ•°å­— æˆ– owner/repo#æ•°å­—ï¼ˆç²¾ç¡®åŒ¹é…å½“å‰ä»“åº“ï¼‰
              const repoRegex = new RegExp(
                `(?:^|\\s)(?:#(\\d+)|${context.repo.owner}/${context.repo.repo}#(\\d+))`,
                'gm'
              );
              
              const matches = text.matchAll(repoRegex) || [];
              return Array.from(matches, match => {
                // ä¼˜å…ˆæ•è·è·¨ä»“åº“å¼•ç”¨ï¼ˆç¬¬äºŒæ•è·ç»„ï¼‰
                return match[2] ? parseInt(match[2], 10) : parseInt(match[1], 10);
              }).filter(num => !isNaN(num));
            };

            // éªŒè¯ Issue/PR å½’å±
            const isValidTarget = async (number) => {
              try {
                await github.rest.issues.get({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: number,
                  headers: { "X-GitHub-Api-Version": "2022-11-28" }
                });
                return true;
              } catch (error) {
                // 404 è¡¨ç¤ºç›®æ ‡ä¸å­˜åœ¨æˆ–ä¸å±äºæœ¬ä»“åº“
                if (error.status === 404) return false;
                // å…¶ä»–é”™è¯¯è§†ä¸ºæ— æ•ˆ
                console.error('Validation error:', error);
                return false;
              }
            };

            // å¼‚æ­¥æ‰¹æ¬¡å¤„ç†å™¨
            const batchProcessor = async (items, processor, batchSize = 10) => {
              const results = [];
              for (let i = 0; i < items.length; i += batchSize) {
                const batch = items.slice(i, i + batchSize);
                const batchResults = await Promise.all(batch.map(processor));
                results.push(...batchResults);
                // é¿å…è§¦å‘ GitHub API é€Ÿç‡é™åˆ¶
                await new Promise(resolve => setTimeout(resolve, 500));
              }
              return results;
            };

            try {
              // é˜¶æ®µ 1ï¼šæ•°æ®æ”¶é›†
              const targets = new Set();
              
              // æ”¶é›†å½“å‰ PR è‡ªèº«
              if (context.payload.pull_request?.number) {
                targets.add(context.payload.pull_request.number);
              }

              // æ”¶é›† PR ç›¸å…³å†…å®¹
              if (context.payload.pull_request) {
                const { data: pr } = await github.rest.pulls.get({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  pull_number: context.payload.pull_request.number,
                  headers: { "X-GitHub-Api-Version": "2022-11-28" }
                });

                // å¤„ç†æ ‡é¢˜å’Œæ­£æ–‡
                [pr.title, pr.body].forEach(text => {
                  extractValidReferences(text).forEach(num => targets.add(num));
                });

                // å¤„ç†è¯„è®ºï¼ˆå¸¸è§„è¯„è®º + ä»£ç è¯„å®¡è¯„è®ºï¼‰
                const [comments, reviews] = await Promise.all([
                  github.rest.issues.listComments({
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                    issue_number: context.payload.pull_request.number,
                    per_page: 100
                  }),
                  github.rest.pulls.listReviewComments({
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                    pull_number: context.payload.pull_request.number,
                    per_page: 100
                  })
                ]);

                [...comments.data, ...reviews.data].forEach(comment => {
                  extractValidReferences(comment.body).forEach(num => targets.add(num));
                });
              }

              // å¤„ç†æäº¤ä¿¡æ¯
              context.payload.commits?.forEach(commit => {
                extractValidReferences(commit.message).forEach(num => targets.add(num));
              });

              // é˜¶æ®µ 2ï¼šæ•°æ®éªŒè¯
              const candidateNumbers = Array.from(targets);
              console.log('Candidate targets:', candidateNumbers);
              
              // æ‰¹æ¬¡éªŒè¯æœ‰æ•ˆæ€§
              const validationResults = await batchProcessor(
                candidateNumbers,
                async num => ({ num, valid: await isValidTarget(num) })
              );
              
              const validNumbers = validationResults
                .filter(r => r.valid)
                .map(r => r.num);

              console.log('Validated targets:', validNumbers);
              if (validNumbers.length === 0) {
                console.log('No valid targets found');
                return;
              }

              // é˜¶æ®µ 3ï¼šè¯„è®ºå‘é€
              const commentTemplate = `ğŸ“¦ **cherry-markdown dev preview published**
              âš ï¸ **æ³¨æ„**: æ­¤ç‰ˆæœ¬ä¸ºå¼€å‘é¢„è§ˆç‰ˆï¼Œç¦æ­¢åœ¨ç”Ÿäº§ç¯å¢ƒä½¿ç”¨ï¼
              âš ï¸ **Note**: This version is a developer preview and should not be used in production environments!
              
              **Install [NPM](https://www.npmjs.com/package/${process.env.PACKAGE_NAME}/v/${process.env.PACKAGE_VERSION}) with** :
              \`\`\`bash
              npm install ${process.env.PACKAGE_NAME}@${process.env.PACKAGE_VERSION}
              \`\`\`
              `;

              // å¹¶å‘å‘é€æ§åˆ¶ï¼ˆæ¯ç§’ 2 ä¸ªè¯·æ±‚ï¼‰
              await batchProcessor(
                validNumbers,
                async number => {
                  try {
                    await github.rest.issues.createComment({
                      owner: context.repo.owner,
                      repo: context.repo.repo,
                      issue_number: number,
                      body: commentTemplate,
                      headers: { "X-GitHub-Api-Version": "2022-11-28" }
                    });
                    console.log(`Commented on #${number}`);
                  } catch (error) {
                    console.error(`Failed to comment on #${number}:`, error.message);
                  }
                },
              );

            } catch (error) {
              console.error('Workflow failed:', error);
              // ä»…åœ¨å½“å‰ PR ä¸ŠæŠ¥å‘Šé”™è¯¯
              if (context.payload.pull_request?.number) {
                await github.rest.issues.createComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: context.payload.pull_request.number,
                  body: `ğŸš¨ å‘å¸ƒæµç¨‹å¤±è´¥: ${error.message}`
                });
              }
            }
