name: 'Publish Cherry-Markdown Dev Preview on PR Merge'

on:
  pull_request_target:
    types: [closed]
    paths:
      - 'packages/cherry-markdown/**'

permissions:
  contents: read
  pull-requests: write
  issues: write

jobs:
  npm-preview:
    # ä¸éœ€è¦åœ¨forkä»“åº“çš„prä¸­è¿è¡Œ, ä»…å½“pråˆå¹¶æ—¶è¿è¡Œ
    if: github.repository == 'Tencent/cherry-markdown' && github.event.pull_request.merged == true && github.event.pull_request.base.ref == 'dev'
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Get Merge Commit SHA
        run: echo "COMMIT_SHORT_SHA=${GITHUB_SHA:0:7}" >> $GITHUB_ENV

      - name: Install dependencies
        run: sudo apt-get install -y moreutils

      - name: Update package.json
        working-directory: ./packages/cherry-markdown
        run: |
          BASE_VERSION=$(jq -r .version package.json)
          VERSION="${BASE_VERSION}-dev.$(date +'%Y%m%d%H%M').${{ env.COMMIT_SHORT_SHA }}"
          jq --arg name "@cherry-markdown/cherry-markdown-dev" \
             --arg version "$VERSION" \
             '.name = $name | .version = $version | del(.scripts.publish?)' package.json | sponge package.json
          echo "PACKAGE_VERSION=$VERSION" >> $GITHUB_ENV
          echo "PACKAGE_NAME=@cherry-markdown/cherry-markdown-dev" >> $GITHUB_ENV

      - name: Update README
        working-directory: ./packages/cherry-markdown
        run: |
          cat <<-EOF > README.md
            **âš ï¸ å¼€å‘é¢„è§ˆè­¦å‘Š / Development Preview Warning**

            æ­¤ç‰ˆæœ¬ä¸º[ä¸´æ—¶æµ‹è¯•ç‰ˆ](${PACKAGE_NAME}@${PACKAGE_VERSION})ï¼Œç¦æ­¢åœ¨ç”Ÿäº§çŽ¯å¢ƒä½¿ç”¨ï¼  

            This is a [development preview version](${PACKAGE_NAME}@${PACKAGE_VERSION}), do NOT use in production!  

          EOF

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: lts/*
          registry-url: https://registry.npmjs.org/
          cache: yarn

      - name: Install and build
        working-directory: ./packages/cherry-markdown
        run: yarn install && yarn build

      - name: npm publish
        working-directory: ./packages/cherry-markdown
        run: npm publish
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN_ORG_DEV }}

      - name: Post comments
        uses: actions/github-script@v7
        with:
          script: |
            const commentTemplate = `ðŸ“¦ **cherry-markdown dev preview published**
              
              âš ï¸ **æ³¨æ„**: æ­¤ç‰ˆæœ¬ä¸ºå¼€å‘é¢„è§ˆç‰ˆï¼Œç¦æ­¢åœ¨ç”Ÿäº§çŽ¯å¢ƒä½¿ç”¨ï¼
              > æ­¤æ–¹å¼å¼•ç”¨ä»£ç ä¸­ä»ç„¶å¯ä»¥ä½¿ç”¨ \`cherry-markdown\` åŒ…åï¼Œä¸éœ€è¦ä¿®æ”¹çŽ°æœ‰çš„ import è¯­å¥
              
              âš ï¸ **Note**: This version is a developer preview and should not be used in production environments!
              > This way of referencing allows you to still use the package name \`cherry-markdown\`, no need to modify existing import statements
              
              **Install [NPM](https://www.npmjs.com/package/${process.env.PACKAGE_NAME}/v/${process.env.PACKAGE_VERSION}) with** :
              \`\`\`bash
              pnpm add cherry-markdown@npm:${process.env.PACKAGE_NAME}@${process.env.PACKAGE_VERSION}
              \`\`\`
              
              \`\`\`bash
              npm i cherry-markdown@npm:${process.env.PACKAGE_NAME}@${process.env.PACKAGE_VERSION}
              \`\`\`
              `;

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: commentTemplate
            });
